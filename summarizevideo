#!/usr/bin/env bash
# Summarizes YouTube videos by extracting captions and using AI APIs to generate summaries
# Supports Gemini and DeepSeek APIs with automatic fallback
# Outputs markdown formatted summary

set -euo pipefail
shopt -s inherit_errexit

readonly VERSION="1.0.0"
readonly SCRIPT_NAME=$(basename "$0")

# Source utility libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd -P)"
source "${SCRIPT_DIR}/require.sh"
source "${SCRIPT_DIR}/util.sh"

function version() {
  printf "%s\n" "$VERSION"
}

function usage() {
  local exit_code=${1:-0}
  local output=${exit_code:-1}
  if [[ $exit_code -eq 0 ]]; then
    output=1
  else
    output=2
  fi

  >&"$output" cat << EOF
Usage: ${SCRIPT_NAME} [OPTIONS] <youtube-video-id>

Options:
  -c, --caption-only  Extract captions only without summarization
  -v, --verbose       Enable verbose output
  -q, --quiet         Suppress non-error output
  --version           Show version information
  --help              Show this help message

Examples:
  ${SCRIPT_NAME} dQw4w9WgXcQ
  ${SCRIPT_NAME} --caption-only dQw4w9WgXcQ > captions.txt
EOF

  exit "$exit_code"
}

function check_dependencies() {
  require_commands jq curl yt-dlp
}

function extract_text_from_vtt() {
  local vtt_file="$1"
  grep -vE '^[0-9]+$|^[0-9]{2}:' "$vtt_file" |
    sed -e '/^WEBVTT/d' \
      -e '/^Kind/d' \
      -e '/^Language/d' \
      -e 's/\[Music\]//g' \
      -e '/^[[:space:]]*$/d' \
      -e 's/<[^>]*>//g' |
    tr '\n' ' ' |
    jq -Rs . | fold -s -w 1000
}

function get_video_title() {
  local video_id="$1"
  curl --fail-with-body --retry 2 --retry-delay 10 -s "https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${video_id}&key=${YOUTUBE_API_KEY}" |
    jq -r '.items[0].snippet.title'
}

function download_captions() {
  local video_id="$1"
  rm -f "${video_id}.*"
  yt-dlp --write-auto-sub --sub-lang "en" --skip-download --sub-format "vtt" \
    -o "${video_id}.%(ext)s" "https://www.youtube.com/watch?v=${video_id}" > /dev/null 2>&1
}

function summarize_chunk_gemini() {
  local chunk="$1"
  local payload
  payload="$(
    cat << EOM
{
  "contents": [{
    "parts": [{
      "text": "Summarize this podcast transcript, excluding plugs, branding, and promotions. Omit mention of Day, podcast and Rosary in a Day. The listener knows that already:\n\n${chunk}"
    }]
  }],
  "generationConfig": {
    "temperature": 0.5
  }
}
EOM
  )"

  local response
  response="$(
    curl --fail-with-body --retry 2 --retry-delay 10 -s \
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "$payload"
  )"

  if ! echo "$response" | jq . > /dev/null 2>&1; then
    err "Gemini API returned invalid response"
    return 1
  fi

  echo "$response" | jq -r '.candidates[0].content.parts[0].text'
}

function summarize_chunk_deepseek() {
  local chunk="$1"
  local payload
  payload="$(
    cat << EOM
{
  "model": "deepseek-chat",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant that summarizes YouTube transcripts. Exclude plugs, branding, and service/product promotions. Omit mention of Day, podcast and Rosary in a Day. The listener knows that already."
    },
    {
      "role": "user",
      "content": "Summarize this podcast transcript:\n\n${chunk}"
    }
  ],
  "temperature": 0.5
}
EOM
  )"

  local response
  response="$(
    curl --fail-with-body --retry 2 --retry-delay 10 -s https://api.deepseek.com/chat/completions \
      -H "Authorization: Bearer ${DEEPSEEK_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "$payload"
  )"

  if ! echo "$response" | jq . > /dev/null 2>&1; then
    err "DeepSeek API returned invalid response"
    return 1
  fi

  echo "$response" | jq -r '.choices[0].message.content'
}

function summarize_chunk() {
  local chunk="$1"
  if [[ -n "${GEMINI_API_KEY:-}" ]]; then
    local summary
    summary=$(summarize_chunk_gemini "$chunk" 2> /dev/null || true)
    if [[ -n "$summary" ]]; then
      echo "$summary"
      return 0
    fi
  fi

  if [[ -n "${DEEPSEEK_API_KEY:-}" ]]; then
    local summary
    summary=$(summarize_chunk_deepseek "$chunk" 2> /dev/null || true)
    if [[ -n "$summary" ]]; then
      echo "$summary"
      return 0
    fi
  fi

  err "Failed to summarize chunk (no working API available)"
  return 1
}

function final_summary_gemini() {
  local input="$1"
  local escaped_input
  escaped_input=$(jq -Rs <<< "$input")
  local payload
  payload=$(jq -n \
    --arg input "$escaped_input" \
    '{
      "contents": [{
        "parts": [{
          "text": ("Condense the following. Highlight the main topics discussed, key takeaways, and any notable quotes or insights. Keep it concise and clear, suitable for someone who wants a quick overview. Start with a level three header and annotate it as '\''AI-Generated Summary:'\'' followed by your generated title. Use no less than 500 words.\n\n" + $input)
        }]
      }],
      "generationConfig": {
        "temperature": 0.5
      }
    }')

  local response
  response=$(
    curl --fail-with-body --retry 2 --retry-delay 10 -s \
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${GEMINI_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "$payload"
  )

  if ! echo "$response" | jq . > /dev/null 2>&1; then
    err "Gemini API returned invalid response"
    return 1
  fi

  echo "$response" | jq -r '.candidates[0].content.parts[0].text'
}

function final_summary_deepseek() {
  local input="$1"
  local escaped_input
  escaped_input=$(jq -Rs <<< "$input")
  local payload
  payload=$(jq -n \
    --arg input "$escaped_input" \
    '{
      "model": "deepseek-chat",
      "messages": [
        {
          "role": "system",
          "content": "Condense the following. Highlight the main topics discussed, key takeaways, and any notable quotes or insights. Keep it concise and clear, suitable for someone who wants a quick overview. Start with a level three header and annotate it as '\''AI-Generated Summary:'\'' followed by your generated title. Use no less than 500 words."
        },
        {
          "role": "user",
          "content": $input
        }
      ],
      "temperature": 0.5
    }')

  local response
  response=$(
    curl --fail-with-body --retry 2 --retry-delay 10 -s https://api.deepseek.com/chat/completions \
      -H "Authorization: Bearer ${DEEPSEEK_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "$payload"
  )

  if ! echo "$response" | jq . > /dev/null 2>&1; then
    err "DeepSeek API returned invalid response"
    return 1
  fi

  echo "$response" | jq -r '.choices[0].message.content'
}

function main() {
  local caption_only=false
  local verbose=false
  local quiet=false

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -c | --caption-only)
        caption_only=true
        shift
        ;;
      -v | --verbose)
        verbose=true
        shift
        ;;
      -q | --quiet)
        quiet=true
        shift
        ;;
      --version)
        version
        exit 0
        ;;
      --help) usage 0 ;;
      --)
        shift
        break
        ;;
      -*) usage 1 ;;
      *) break ;;
    esac
  done

  if [[ $# -eq 0 ]]; then
    usage 1
  fi

  local VIDEO_ID="$1"

  require_vars YOUTUBE_API_KEY
  if [[ -z "${GEMINI_API_KEY:-}" && -z "${DEEPSEEK_API_KEY:-}" ]]; then
    die "Error: At least one of GEMINI_API_KEY or DEEPSEEK_API_KEY environment variables must be set"
  fi

  check_dependencies

  local VIDEO_TITLE
  VIDEO_TITLE=$(get_video_title "$VIDEO_ID")
  if [[ "$VIDEO_TITLE" == "null" ]]; then
    die "Error: Could not fetch video title"
  fi

  download_captions "$VIDEO_ID"
  if [[ ! -f "${VIDEO_ID}.en.vtt" ]]; then
    die "Error: Subtitle file not found"
  fi

  local TRANSCRIPT
  TRANSCRIPT=$(extract_text_from_vtt "${VIDEO_ID}.en.vtt")
  TRANSCRIPT="${TRANSCRIPT:1:-1}"

  if [[ -z "$TRANSCRIPT" ]]; then
    die "Error: Transcript conversion failed"
  fi

  if "$caption_only"; then
    echo "$TRANSCRIPT" > "${VIDEO_ID}.en.txt"
    exit 0
  fi

  local CHUNK_SIZE=8000
  local TOTAL_LEN=${#TRANSCRIPT}
  local CHUNKS=()
  for ((i = 0; i < TOTAL_LEN; i += CHUNK_SIZE)); do
    CHUNKS+=("${TRANSCRIPT:i:CHUNK_SIZE}")
  done

  local INTERMEDIATE_SUMMARIES=()
  for chunk in "${CHUNKS[@]}"; do
    local summary
    summary=$(summarize_chunk "$chunk")
    INTERMEDIATE_SUMMARIES+=("$summary")
    sleep 15
  done

  local FINAL_INPUT
  FINAL_INPUT=$(printf "%s\n\n" "${INTERMEDIATE_SUMMARIES[@]}")
  sleep 15

  local FINAL_SUMMARY=""
  if [[ -n "${GEMINI_API_KEY:-}" ]]; then
    FINAL_SUMMARY=$(final_summary_gemini "$FINAL_INPUT" || true)
  fi

  if [[ (-z "$FINAL_SUMMARY" || -z "${GEMINI_API_KEY:-}") && -n "${DEEPSEEK_API_KEY:-}" ]]; then
    FINAL_SUMMARY=$(final_summary_deepseek "$FINAL_INPUT")
  fi

  if [[ -z "$FINAL_SUMMARY" ]]; then
    die "ERROR: Failed to generate final summary (no working API available)"
  fi

  echo -e "${FINAL_SUMMARY}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
