#!/usr/bin/env bash

readonly VERSION="1.0.0"
readonly SCRIPT_NAME="$(basename "$0")"

# Resolve script directory
if command -v realpath > /dev/null 2>&1; then
  SCRIPT_DIR=$(dirname "$(realpath "$0")")
else
  SCRIPT_DIR=$(cd -- "$(dirname -- "$0")" && pwd -P)
fi
source "${SCRIPT_DIR}/lockconfig.sh"
lock_config_vars "${SCRIPT_DIR}/config.env"
function version() {
  printf "%s\n" "$VERSION"
}

function main() {

  # Output file
  OUTPUT="stitch.md"
  if [[ -f "$OUTPUT" ]]; then
    cp "$OUTPUT" "${OUTPUT}.bak"
    rm -f "$OUTPUT"
  fi

  # Write header
  echo "# README" > "$OUTPUT"
  echo >> "$OUTPUT"

  # Iterate and write links; warn if file is missing
  for entry in "${CONTENT_DOCS[@]}"; do
    IFS='=' read -r label path <<< "$entry"
    echo "- [$label]($path)" >> "$OUTPUT"
    if [[ ! -f "$path" ]]; then
      echo "Warning: File '$path' not found for label '$label'" >&2
    fi
  done

  echo "stitch.md generated successfully."
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  if "$LOGGING"; then
    timestamp=$(date +"%Y%m%d_%H%M%S")
    {
      main "$@" 2> >(tee -a "${SCRIPT_NAME%.*}_${timestamp}.stderr.log" >&2)
    } | tee -a "${SCRIPT_NAME%.*}_${timestamp}.stdout.log"
  else
    main "$@"
  fi
fi
