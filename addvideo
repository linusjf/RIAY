#!/usr/bin/env bash
require() {
  hash "$@" || exit
}
usage() {
  echo "$0 [-n|--dry-run] vid caption"
  echo "vid - video id"
  echo "caption - video title"
  echo "-n, --dry-run - show what would happen without making changes"
  exit 1
}
set -euo pipefail
shopt -s inherit_errexit
require sed basename date markdown-toc

DRY_RUN=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -n | --dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

if test $# -ne 2; then
  usage
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
#shellcheck disable=SC1091
source "${SCRIPT_DIR}/internet.sh"
checkinternet || exit

#shellcheck disable=SC1091
source "${SCRIPT_DIR}/vidmd.sh"
vid="$1"
caption="$2"

if ! validate_vid "$vid"; then
  exit 1
fi

if ! validate_caption "$caption"; then
  exit 1
fi
YEAR=2025

doy=$(("$(wc -l < videos.txt)" + 1))
videourl="https://youtu.be/${vid}"
year="${YEAR}"

if $DRY_RUN; then
  echo "DRY RUN: Would generate overlay for video $vid"
  md="$("${SCRIPT_DIR}/genvidthmd" "$vid" "$videourl" "$caption" "$doy")"
  month="$(mfromdoy "$doy")"
  fname="${month}/Day$(printf "%03d" "${doy#0}").md"
  formatdt="$(datefromdoy "$doy")"
  monthmd="${month}${year}.md"
  echo "DRY RUN: Would create file $fname with contents:"
  echo "## $formatdt"
  echo
  echo "### $caption"
  echo
  echo "$md"
  echo
  echo "DRY RUN: Would append to ${month}/compact.txt and videos.txt"
  echo "DRY RUN: Would generate $monthmd with table of contents"
  exit 0
fi

if "${SCRIPT_DIR}/genoverlay" "$vid" "$doy"; then
  md="$("${SCRIPT_DIR}/genvidthmd" "$vid" "$videourl" "$caption" "$doy")"
  month="$(mfromdoy "$doy")"
  fname="${month}/Day$(printf "%03d" "${doy#0}").md"
  formatdt="$(datefromdoy "$doy")"
  if test -f "$fname"; then
    mv "$fname" "${fname}.bak"
    if test $? -eq 0; then
      echo "File ${fname} exists. Moved to ${fname}.bak"
    else
      echo "Back up of ${fname} unsuccessful. It will be overwritten." >&2
    fi
  fi
  echo "## $formatdt" >| "$fname"
  {
    echo
    echo "### $caption"
    echo
    echo "$md"
  } >> "$fname"

  rm -f "${month}/compact.txt.bak" && cp "${month}/compact.txt" "${month}/compact.txt.bak"
  basename -- "$fname" >> "${month}/compact.txt"
  monthmd="${month}${year}.md"
  if "${SCRIPT_DIR}/compact" "$month" >| "$monthmd" && markdown-toc-gen update "$monthmd" &> /dev/null; then
    sed -i '/\S/,$!d' "$monthmd"
    printf "%s\n" "$vid" >> videos.txt
    printf "%s generated for %s.\n" "$fname" "$vid"
    exit 0
  else
    printf "Error generating %s.\n" "$monthmd" >&2
    mv "${month}/compact.txt.bak" "${month}/compact.txt"
    exit 1
  fi
else
  printf "Unable to find or generate video thumbnail. Video may not exist or the overlay generation failed. The video id '%s' may be invalid.\n" "$vid" >&2
  exit 1
fi
