#!/usr/bin/env bash
set -euo pipefail
shopt -s inherit_errexit

function get_gemini_models() {
  # Ensure GEMINI_API_KEY is set
  : "${GEMINI_API_KEY:?Environment variable GEMINI_API_KEY must be set}"

  # Fetch the list of models from the Gemini API
  response="$(curl::safe_curl_request "https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}")"

  # Extract model IDs, filter for Gemini models, sort them, and store in an array
  readarray -t gemini_models < <(
    echo "$response" | jq -r '.models[] | select((.description // "" | test("legacy|deprecated"; "i") | not) and ((.supportedGenerationMethods // []) | map(test("generate")) | any)) | .name' \
      | grep '^models/gemini' \
      | sed 's/^models\///' \
      | sort -r
  )
  printf "%s\n" "${gemini_models[@]}" >| geminimodelids.txt
}

if command -v realpath > /dev/null 2>&1; then
  readonly SCRIPT_DIR="$(dirname "$(realpath "$0")")"
else
  readonly SCRIPT_DIR="$(cd -- "$(dirname -- "$0")" &> /dev/null && pwd -P)"
fi

source "${SCRIPT_DIR}/curl.sh"

get_gemini_models
