#!/usr/bin/env bash
set -euo pipefail
shopt -s inherit_errexit

function get_gemini_models() {
  # Ensure GEMINI_API_KEY is set
  : "${GEMINI_API_KEY:?Environment variable GEMINI_API_KEY must be set}"

  # Fetch the list of models from the Gemini API
  response=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}")

  # Extract model IDs, filter for Gemini models, sort them, and store in an array
  readarray -t gemini_models < <(
    echo "$response" | jq -r '.models[] | select((.description // "" | test("legacy|deprecated"; "i") | not) and ((.supportedGenerationMethods // []) | map(test("generate")) | any)) | .name' \
      | grep '^models/gemini' \
      | sed 's/^models\///' \
      | sort -r
  )
  printf "%s\n" "${gemini_models[@]}" >| geminimodelids.txt
}

get_gemini_models
