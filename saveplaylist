#!/usr/bin/env bash

# Check for playlist ID argument
if [ -z "$1" ]; then
  echo "Usage: $0 PLAYLIST_ID"
  exit 1
fi

# Check if YOUTUBE_API_KEY is set
if [ -z "$YOUTUBE_API_KEY" ]; then
  echo "Error: YOUTUBE_API_KEY environment variable is not set."
  exit 1
fi

PLAYLIST_ID="$1"
OUTPUT_FILE="videos.txt"
NEXT_PAGE_TOKEN=""
BASE_URL="https://www.googleapis.com/youtube/v3/playlistItems"
MAX_RESULTS=50

# Clear or create the output file
true > "$OUTPUT_FILE"

while :; do
  # Build the API request URL
  URL="${BASE_URL}?part=contentDetails&playlistId=${PLAYLIST_ID}&maxResults=${MAX_RESULTS}&key=${YOUTUBE_API_KEY}"

  if [[ -n "$NEXT_PAGE_TOKEN" ]]; then
    URL="${URL}&pageToken=${NEXT_PAGE_TOKEN}"
  fi

  # Fetch the response
  RESPONSE=$(curl -s "$URL")

  # Extract video IDs and append to output
  echo "$RESPONSE" | jq -r '.items[].contentDetails.videoId' >> "$OUTPUT_FILE"

  # Get the next page token
  NEXT_PAGE_TOKEN=$(echo "$RESPONSE" | jq -r '.nextPageToken')

  # Stop if there is no next page
  if [[ "$NEXT_PAGE_TOKEN" == "null" ]]; then
    break
  fi
done

echo "Video IDs saved to $OUTPUT_FILE"
