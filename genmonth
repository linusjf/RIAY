#!/usr/bin/env bash
require() {
  hash "$@" || exit
}
set -euo pipefail
shopt -s inherit_errexit
require date markdown-toc
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
#shellcheck disable=SC1091
source "$SCRIPT_DIR/vidmd.sh"
usage() {
  echo "$0 [-n|--dry-run] month year"
  echo "month - month number (1 - 12)"
  echo "year - 4 digit year"
  echo "-n, --dry-run - show what would happen without making changes"
  exit 1
}

DRY_RUN=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -n | --dry-run)
      DRY_RUN=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ $# -eq 0 ]; then
  echo "No arguments provided"
  usage
fi

if [ $# -eq 1 ]; then
  echo "One argument provided: $1"
  usage
fi

if [ $# -gt 2 ]; then
  echo "More than two arguments provided"
  usage
fi

if ! isnumeric "$1"; then
  usage
fi
if ! isnumeric "$2"; then
  usage
fi
year="$2"
len=$((${#year}))
if ((len != 4)); then
  usage
fi
month=$((10#$1))
if ((month < 1 || month > 12)); then
  usage
fi
if [ "$len" -ne 4 ]; then
  usage
fi

month="$(monthfromnumber "$((10#${month}))")"
monthmd="${month}${year}.md"

if $DRY_RUN; then
  echo "DRY RUN: Would process month $month ($(monthfromnumber "$month")) for year $year"
  echo "DRY RUN: Would generate these files:"
  echo "  - $monthmd (monthly markdown file)"
  echo "DRY RUN: Would run these commands:"
  echo "  - ${SCRIPT_DIR}/compact \"$month\" >| \"$monthmd\""
  echo "  - ${SCRIPT_DIR}/gentoc \"$monthmd\""
  echo "  - sed -i '/\\S/,\$!d' \"$monthmd\""
  echo "DRY RUN: No files would actually be modified"
  exit 0
fi

if ! "${SCRIPT_DIR}/compact" "$month" >| "$monthmd"; then
  echo "Error running compact"
  exit 1
fi

if ! "${SCRIPT_DIR}/gentoc" "$monthmd"; then
  echo "Error running ${SCRIPT_DIR}/gentoc"
  exit 1
fi

if ! sed -i '/\S/,$!d' "$monthmd"; then
  echo "Error running sed"
  exit 1
fi
exit 0
